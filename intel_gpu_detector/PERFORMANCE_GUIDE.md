# 性能优化指南

本指南介绍如何优化 VALORANT 检测系统以获得最佳性能。

## 最新优化功能 (v2.0)

### 🚀 新增优化

1. **类别过滤优化** - 只检测 `head` 类
   - 在后处理阶段提前过滤其他类别
   - 减少 NMS 计算量
   - 提升 5-10% 性能

2. **预处理快速路径** - 零拷贝优化
   - 当捕获尺寸 = 模型尺寸时（256x256），跳过 resize 和 padding
   - 节省 ~2-3ms 预处理时间
   - **你的配置正好符合此优化！**

3. **内存预分配** - 减少内存分配
   - padding buffer 预分配，避免每帧创建
   - 减少内存碎片和 GC 压力

4. **NMS 向量化** - 向量化 bbox 转换
   - 使用 NumPy 批量操作代替循环
   - 提升 NMS 性能 ~20%

## 性能优化功能

### 1. 可视化开关 (最大提升 20-30%)

**关闭可视化可获得最大性能提升**，因为：
- 节省 OpenCV 绘图开销 (~5-8ms)
- 节省窗口渲染开销 (~3-5ms)
- 节省内存拷贝开销 (~2-3ms)

```python
# 配置文件中设置
enable_visualization = False  # 关闭可视化，提升 20-30% FPS
```

**运行时切换**：
- 按 `V` 键实时切换可视化开启/关闭
- 关闭后会在控制台每30帧输出一次检测结果

### 2. CPU 线程优化

**设置为物理核心数可获得最佳性能**：

```python
num_threads = 4  # i3-10105F 有 4 个物理核心
```

- `0`：自动检测（默认）
- `4`：推荐设置（i3-10105F 的物理核心数）
- `8`：使用所有逻辑线程（可能不会更快）

### 3. 性能分析模式

开启后可详细查看各个步骤的耗时：

```python
enable_profiling = True
```

**使用方法**：
- 运行时按 `P` 键查看实时性能统计
- 退出时自动显示最终性能报告

**统计内容**：
- `capture`: 屏幕捕获耗时
- `detect`: 模型推理耗时（最重要）
- `find_head`: 查找最近头部耗时
- `visualize`: 可视化绘图耗时
- `total`: 总循环耗时

### 4. 检测阈值优化

**提高置信度阈值可减少计算量**：

```python
conf_threshold = 0.60  # 提高到 0.60，减少误检和后处理计算
```

- `0.40-0.50`：更多检测，更多误报
- `0.55`：平衡（推荐）
- `0.60-0.70`：更少误报，可能漏检

## 使用模式

### 默认模式（平衡）

```bash
python simple_detector.py
```

- 可视化：开启
- 性能分析：关闭
- 预期 FPS：50-60

### 极致性能模式

修改 `simple_detector.py` 中的 `main()` 函数：

```python
enable_visualization = False  # 关闭可视化
enable_profiling = False
conf_threshold = 0.60        # 提高阈值
num_threads = 4
```

**预期 FPS：70-80**

### 调试模式

```python
enable_visualization = True
enable_profiling = True      # 开启性能分析
conf_threshold = 0.50
```

按 `P` 查看详细统计，分析性能瓶颈。

## 预期性能（i3-10105F + 256模型）

| 模式 | 可视化 | FPS | 延迟 | 说明 |
|------|--------|-----|------|------|
| **极致性能 v2** | 关闭 | 80-90 | ~11ms | 新优化版本 |
| 极致性能 v1 | 关闭 | 70-80 | ~13ms | 旧版本 |
| 默认模式 v2 | 开启 | 60-70 | ~15ms | 新优化版本 |
| 默认模式 v1 | 开启 | 50-60 | ~17ms | 旧版本 |
| 调试模式 | 开启+分析 | 45-55 | ~20ms | 性能分析开销 |

**v2 优化带来约 15-20% 性能提升！**

## 键盘控制

运行时可用按键：

- `Q` - 退出程序
- `V` - 切换可视化开启/关闭（实时）
- `P` - 打印性能统计（需开启 `enable_profiling`）

## 输出模式

### 有可视化模式
显示实时画面，包含：
- 检测框和标签
- 中心准星
- 最近头部的距离和偏移
- FPS 和检测数量

### 无可视化模式
控制台每30帧输出一次：
```
[FPS:  75] Head detected - Distance:   42.3px, Offset: ( -15.2,  +8.7)
[FPS:  76] No head detected
```

## 进一步优化建议

### 1. 使用更小的模型
如果 256 模型仍然不够快，可以尝试：
- 训练一个 128x128 的模型（需要重新训练）
- 减小捕获区域大小

### 2. 减小捕获区域
```python
center_size = 224  # 从 256 减小到 224
# 注意：需要在预处理中添加 resize
```

### 3. 跳帧检测
每隔 N 帧检测一次（牺牲准确性换取速度）：
```python
if frame_count % 2 == 0:  # 每隔1帧检测
    detections, _, _ = self.detector.detect(frame)
```

### 4. 降低 NMS 计算
```python
iou_threshold = 0.50  # 提高到 0.50，减少 NMS 计算量
```

## 性能监控

开启 `enable_profiling=True` 后，查看各步骤耗时：

```
性能统计 (最近100帧平均)
============================================================
capture     :   0.35ms (min:  0.28, max:  0.52)
detect      :  12.80ms (min: 11.20, max: 15.30)
find_head   :   0.08ms (min:  0.05, max:  0.15)
visualize   :   4.20ms (min:  3.80, max:  5.50)
total       :  17.43ms (min: 15.50, max: 20.10)
============================================================
```

**优化重点**：
- `detect` 占用最多（~70-75%）- 模型推理，通过提高阈值或减小模型优化
- `visualize` 次之（~20-25%）- 关闭可视化可消除
- `capture` 和 `find_head` 可忽略（<1%）

## 配置示例

文件中已提供三个预设函数：

1. `main()` - 默认平衡模式
2. `main_performance_mode()` - 极致性能模式
3. `main_debug_mode()` - 调试模式

切换方法：
```python
if __name__ == "__main__":
    main_performance_mode()  # 使用性能模式
```

## 疑难解答

### FPS 仍然低于预期

1. 检查 CPU 是否被其他程序占用
2. 确认 `num_threads=4`（物理核心数）
3. 关闭可视化 `enable_visualization=False`
4. 提高置信度阈值到 0.60-0.65
5. 使用性能分析找到瓶颈

### 检测不到目标

1. 降低置信度阈值到 0.45-0.50
2. 增大捕获区域 `center_size=320`
3. 检查 Moonlight 是否全屏运行

### 内存占用过高

1. 减小性能统计窗口大小（修改 `deque(maxlen=100)` 为 `maxlen=30`）
2. 关闭性能分析 `enable_profiling=False`
